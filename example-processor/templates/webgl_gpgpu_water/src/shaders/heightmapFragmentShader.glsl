"\n\n\t\t\t#include <common>\n\n\t\t\tuniform vec2 mousePos;\n\t\t\tuniform float mouseSize;\n\t\t\tuniform float viscosityConstant;\n\t\t\tuniform float heightCompensation;\n\n\t\t\tvoid main()\t{\n\n\t\t\t\tvec2 cellSize = 1.0 / resolution.xy;\n\n\t\t\t\tvec2 uv = gl_FragCoord.xy * cellSize;\n\n\t\t\t\t// heightmapValue.x == height from previous frame\n\t\t\t\t// heightmapValue.y == height from penultimate frame\n\t\t\t\t// heightmapValue.z, heightmapValue.w not used\n\t\t\t\tvec4 heightmapValue = texture2D( heightmap, uv );\n\n\t\t\t\t// Get neighbours\n\t\t\t\tvec4 north = texture2D( heightmap, uv + vec2( 0.0, cellSize.y ) );\n\t\t\t\tvec4 south = texture2D( heightmap, uv + vec2( 0.0, - cellSize.y ) );\n\t\t\t\tvec4 east = texture2D( heightmap, uv + vec2( cellSize.x, 0.0 ) );\n\t\t\t\tvec4 west = texture2D( heightmap, uv + vec2( - cellSize.x, 0.0 ) );\n\n\t\t\t\t// https://web.archive.org/web/20080618181901/http://freespace.virgin.net/hugo.elias/graphics/x_water.htm\n\n\t\t\t\tfloat newHeight = ( ( north.x + south.x + east.x + west.x ) * 0.5 - heightmapValue.y ) * viscosityConstant;\n\n\t\t\t\t// Mouse influence\n\t\t\t\tfloat mousePhase = clamp( length( ( uv - vec2( 0.5 ) ) * BOUNDS - vec2( mousePos.x, - mousePos.y ) ) * PI / mouseSize, 0.0, PI );\n\t\t\t\tnewHeight += ( cos( mousePhase ) + 1.0 ) * 0.28;\n\n\t\t\t\theightmapValue.y = heightmapValue.x;\n\t\t\t\theightmapValue.x = newHeight;\n\n\t\t\t\tgl_FragColor = heightmapValue;\n\n\t\t\t}\n\n\t\t"